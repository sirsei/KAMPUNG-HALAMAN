-- KAHA AUTO FISHING FINAL VERSION (UPDATED V2)
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local VirtualUser = game:GetService("VirtualUser")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

local AUTO = false
local ANTI_AFK = true
local INPUT_DELAY = 1.8
local RodList = {}
local RodIndex = 1

local AvailableRods = {
    "Pancingan Bambu", "Pancingan Jamur", "Pancingan Panas", "Pancingan Trisula",
    "Pancingan Kristal", "Pancingan Petir Hitam", "Pancingan Gitar", "Pancingan Unyu",
    "Pancingan Dingin", "Pancingan Corrupt", "Pancingan Kuil", "Pancingan Dewa",
    "Pancingan Sabit", "Pancingan Ubur Ubur", "Pancingan Kuncen", "Pancingan Parasol",
    "Pancingan Galaksi", "Pancingan Ksatria", "Pancingan Kegelapan", "Pancingan Volcano",
    "Pancingan Karuhun", "Pancingan Executive"
}

local rarities = { "Common", "UnCommon", "Rare", "Epic", "Legendary", "Mythical", "Unknown" }

--// ================= THEME COLORS =================
local Theme = {
    Main = Color3.fromRGB(12, 12, 15),
    Secondary = Color3.fromRGB(20, 20, 25),
    Accent = Color3.fromRGB(114, 137, 218),
    Green = Color3.fromRGB(46, 204, 113),
    Red = Color3.fromRGB(231, 76, 60),
    Text = Color3.fromRGB(255, 255, 255),
    TextDark = Color3.fromRGB(180, 180, 180)
}

--// ================= LOGIC FUNCTIONS =================
local function findRod(name)
    if Player.Character then
        for _, v in ipairs(Player.Character:GetChildren()) do
            if v:IsA("Tool") and v.Name == name then return v end
        end
    end
    for _, v in ipairs(Player.Backpack:GetChildren()) do
        if v:IsA("Tool") and v.Name == name then return v end
    end
end

local function equipRod(rod)
    if rod and rod.Parent == Player.Backpack then
        Player.Character.Humanoid:EquipTool(rod)
    end
end

local function getNextRod()
    if #RodList == 0 then return end
    for i = 1, #RodList do
        local idx = ((RodIndex - 1 + i - 1) % #RodList) + 1
        local rod = findRod(RodList[idx])
        if rod then
            RodIndex = idx
            return rod
        end
    end
end

Player.Idled:Connect(function()
    if ANTI_AFK then
        VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
        task.wait(1)
        VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    end
end)

--// ================= UI CONSTRUCTION =================
local gui = Instance.new("ScreenGui", Player.PlayerGui)
gui.Name = "SeiXFishing"
gui.ResetOnSpawn = false

--// 1. WELCOME ANIMATION
local function ShowWelcome()
    local welcomeFrame = Instance.new("Frame", gui)
    welcomeFrame.Size = UDim2.fromOffset(280, 65)
    welcomeFrame.Position = UDim2.new(0.5, 0, 1.1, 0)
    welcomeFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    welcomeFrame.BackgroundColor3 = Theme.Main
    welcomeFrame.BorderSizePixel = 0
    Instance.new("UICorner", welcomeFrame).CornerRadius = UDim.new(0, 12)
    local s = Instance.new("UIStroke", welcomeFrame)
    s.Color = Theme.Accent
    s.Thickness = 2

    local l = Instance.new("TextLabel", welcomeFrame)
    l.Size = UDim2.fromScale(1, 1)
    l.BackgroundTransparency = 1
    l.Text = "Welcome! " .. Player.Name
    l.TextColor3 = Theme.Text
    l.Font = Enum.Font.GothamBold
    l.TextSize = 16

    welcomeFrame:TweenPosition(UDim2.new(0.5, 0, 0.85, 0), "Out", "Back", 0.6, true)
    task.wait(2.5)
    welcomeFrame:TweenPosition(UDim2.new(0.5, 0, 1.2, 0), "In", "Quart", 0.6, true)
    task.delay(0.6, function() welcomeFrame:Destroy() end)
end

local main = Instance.new("Frame", gui)
main.Size = UDim2.fromOffset(360, 480)
main.Position = UDim2.fromScale(0.5, 0.5)
main.AnchorPoint = Vector2.new(0.5, 0.5)
main.BackgroundColor3 = Theme.Main
main.BorderSizePixel = 0
main.Active = true
main.Draggable = true
main.BackgroundTransparency = 0.5
Instance.new("UICorner", main).CornerRadius = UDim.new(0, 16)

--// ================= OVERLAY SYSTEM =================
local overlay = Instance.new("Frame", main)
overlay.Name = "Overlay"
overlay.Size = UDim2.fromScale(1,1)
overlay.BackgroundTransparency = 1
overlay.ZIndex = 50
overlay.ClipsDescendants = false

-- Drop Shadow Effect
local shadow = Instance.new("ImageLabel", main)
shadow.Name = "Shadow"
shadow.BackgroundTransparency = 1
shadow.Position = UDim2.new(0, -15, 0, -15)
shadow.Size = UDim2.new(1, 30, 1, 30)
shadow.ZIndex = 0
shadow.Image = "rbxassetid://6014264792"
shadow.ImageColor3 = Color3.new(0,0,0)
shadow.ImageTransparency = 0.5

local topBar = Instance.new("Frame", main)
topBar.Size = UDim2.new(1, 0, 0, 50)
topBar.BackgroundTransparency = 1

-- TITLE CONTAINER (Untuk memisahkan SeiX dan PREMIUM)
local titleFrame = Instance.new("Frame", topBar)
titleFrame.Size = UDim2.new(1, -100, 1, 0)
titleFrame.Position = UDim2.fromOffset(20, 0)
titleFrame.BackgroundTransparency = 1

local titleLayout = Instance.new("UIListLayout", titleFrame)
titleLayout.FillDirection = Enum.FillDirection.Horizontal
titleLayout.VerticalAlignment = Enum.VerticalAlignment.Center
titleLayout.Padding = UDim.new(0, 8)

-- SeiX (RAINBOW)
local seiXText = Instance.new("TextLabel", titleFrame)
seiXText.AutomaticSize = Enum.AutomaticSize.XY
seiXText.BackgroundTransparency = 1
seiXText.Text = "SeiX"
seiXText.TextColor3 = Color3.new(1,1,1)
seiXText.Font = Enum.Font.GothamBold
seiXText.TextSize = 18

-- PREMIUM (GRADIENT)
local premiumText = Instance.new("TextLabel", titleFrame)
premiumText.AutomaticSize = Enum.AutomaticSize.XY
premiumText.BackgroundTransparency = 1
premiumText.Text = "KaHa"
premiumText.TextColor3 = Color3.new(1,1,1)
premiumText.Font = Enum.Font.GothamBold
premiumText.TextSize = 18

local premGradient = Instance.new("UIGradient", premiumText)
premGradient.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 215, 0)), -- Gold
    ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 120, 0))  -- Orange semu merah
})

-- ANIMASI RAINBOW SEIX
task.spawn(function()
    while task.wait() do
        local hue = tick() % 3 / 3
        seiXText.TextColor3 = Color3.fromHSV(hue, 0.6, 1)
    end
end)

local closeBtn = Instance.new("TextButton", topBar)
closeBtn.Size = UDim2.fromOffset(32, 32)
closeBtn.Position = UDim2.new(1, -42, 0, 9)
closeBtn.Text = "Ã—"
closeBtn.BackgroundColor3 = Theme.Secondary
closeBtn.TextColor3 = Theme.Red
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 22
Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 8)

local miniBtn = Instance.new("TextButton", topBar)
miniBtn.Size = UDim2.fromOffset(32, 32)
miniBtn.Position = UDim2.new(1, -80, 0, 9)
miniBtn.Text = "âˆ’"
miniBtn.BackgroundColor3 = Theme.Secondary
miniBtn.TextColor3 = Theme.Text
miniBtn.Font = Enum.Font.GothamBold
miniBtn.TextSize = 22
Instance.new("UICorner", miniBtn).CornerRadius = UDim.new(0, 8)

local container = Instance.new("ScrollingFrame", main)
container.Size = UDim2.new(1, -24, 1, -70)
container.Position = UDim2.fromOffset(12, 60)
container.BackgroundTransparency = 1
container.ScrollBarThickness = 2
container.CanvasSize = UDim2.new(0,0,0,0)
container.AutomaticCanvasSize = Enum.AutomaticSize.Y
container.ScrollBarImageColor3 = Theme.Accent

local listLayout = Instance.new("UIListLayout", container)
listLayout.Padding = UDim.new(0, 12)
listLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center

-- Helper function for buttons
local function createButton(name, color, order)
    local btn = Instance.new("TextButton", container)
    btn.Size = UDim2.new(1, -4, 0, 48)
    btn.BackgroundColor3 = Theme.Secondary
    btn.Text = name
    btn.TextColor3 = Theme.Text
    btn.Font = Enum.Font.GothamSemibold
    btn.TextSize = 14
    btn.LayoutOrder = order
    btn.AutoButtonColor = false
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 10)
    
    local stroke = Instance.new("UIStroke", btn)
    stroke.Color = color
    stroke.Thickness = 1.2
    stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    
    btn.MouseEnter:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(30,30,38)}):Play()
    end)
    btn.MouseLeave:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = Theme.Secondary}):Play()
    end)
    
    return btn, stroke
end

-- 1. ANTI AFK
local afkBtn, afkStroke = createButton("ANTI-AFK: ON", Theme.Accent, 1)
afkBtn.MouseButton1Click:Connect(function()
    ANTI_AFK = not ANTI_AFK
    afkBtn.Text = ANTI_AFK and "ANTI-AFK: ON" or "ANTI-AFK: OFF"
    afkStroke.Color = ANTI_AFK and Theme.Accent or Color3.fromRGB(60, 60, 70)
end)

-- 2. DELAY SETTING
local delayFrame = Instance.new("Frame", container)
delayFrame.Size = UDim2.new(1, -4, 0, 48)
delayFrame.BackgroundColor3 = Theme.Secondary
delayFrame.LayoutOrder = 2
Instance.new("UICorner", delayFrame).CornerRadius = UDim.new(0, 10)

local dLabel = Instance.new("TextLabel", delayFrame)
dLabel.Size = UDim2.new(0.5, 0, 1, 0)
dLabel.Position = UDim2.fromOffset(15, 0)
dLabel.Text = "Wait (s)"
dLabel.TextColor3 = Theme.TextDark
dLabel.BackgroundTransparency = 1
dLabel.Font = Enum.Font.GothamSemibold
dLabel.TextSize = 13
dLabel.TextXAlignment = Enum.TextXAlignment.Left

local delayBox = Instance.new("TextBox", delayFrame)
delayBox.Size = UDim2.fromOffset(60, 28)
delayBox.Position = UDim2.new(1, -75, 0.5, -14)
delayBox.BackgroundColor3 = Theme.Main
delayBox.Text = tostring(INPUT_DELAY)
delayBox.TextColor3 = Theme.Accent
delayBox.Font = Enum.Font.GothamBold
delayBox.TextSize = 14
Instance.new("UICorner", delayBox).CornerRadius = UDim.new(0, 6)

delayBox.FocusLost:Connect(function()
    local v = tonumber(delayBox.Text)
    if v and v >= 0.5 then INPUT_DELAY = v end
    delayBox.Text = tostring(INPUT_DELAY)
end)

-- 3. ROD SELECTION
local rodDrop, rodStroke = createButton("SELECT ROD LOOP  â–¼", Color3.fromRGB(60,60,70), 3)
local rodFrame = Instance.new("ScrollingFrame", overlay)
rodFrame.Size = UDim2.fromOffset(320, 0)
rodFrame.BackgroundColor3 = Color3.fromRGB(15,15,20)
rodFrame.Visible = false
rodFrame.ScrollBarThickness = 2
rodFrame.ZIndex = 60
rodFrame.CanvasSize = UDim2.new(0,0,0,#AvailableRods * 36)
rodFrame.ClipsDescendants = true
Instance.new("UICorner", rodFrame).CornerRadius = UDim.new(0,10)

local rodLayout = Instance.new("UIListLayout", rodFrame)
rodLayout.Padding = UDim.new(0,2)

local function updateRodPos()
    local p = rodDrop.AbsolutePosition
    local s = rodDrop.AbsoluteSize
    local m = main.AbsolutePosition

    rodFrame.Position = UDim2.fromOffset(
        p.X - m.X,
        p.Y - m.Y + s.Y + 6
    )
end

rodDrop.MouseButton1Click:Connect(function()
    updateRodPos()
    rodFrame.Visible = not rodFrame.Visible

    TweenService:Create(
        rodFrame,
        TweenInfo.new(0.35, Enum.EasingStyle.Quart, Enum.EasingDirection.Out),
        {Size = rodFrame.Visible and UDim2.fromOffset(320,160) or UDim2.fromOffset(320,0)}
    ):Play()

    rodDrop.Text = rodFrame.Visible and "SELECT ROD LOOP  â–²" or "SELECT ROD LOOP  â–¼"
end)

for _, rodName in ipairs(AvailableRods) do
    local btn = Instance.new("TextButton", rodFrame)
    btn.Size = UDim2.new(1,-8,0,34)
    btn.Text = "  "..rodName
    btn.BackgroundTransparency = 1
    btn.TextColor3 = Theme.TextDark
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 13
    btn.TextXAlignment = Enum.TextXAlignment.Left
    btn.ZIndex = 61

    local ind = Instance.new("Frame", btn)
    ind.Size = UDim2.fromOffset(4,18)
    ind.Position = UDim2.new(1,-10,0.5,-9)
    ind.BackgroundColor3 = Theme.Red
    ind.ZIndex = 62
    Instance.new("UICorner", ind)

    btn.MouseButton1Click:Connect(function()
        local i = table.find(RodList, rodName)
        if i then
            table.remove(RodList, i)
            ind.BackgroundColor3 = Theme.Red
        else
            table.insert(RodList, rodName)
            ind.BackgroundColor3 = Theme.Green
        end
    end)
end

-- 4. SELL FISH (PREMIUM OVERLAY)
local sellDrop, sellStroke = createButton("SELL FISH MARKET  â–¼", Color3.fromRGB(60,60,70), 5)

local sellFrame = Instance.new("Frame", overlay)
sellFrame.Size = UDim2.fromOffset(300,0)
sellFrame.BackgroundColor3 = Color3.fromRGB(16,17,22)
sellFrame.Visible = false
sellFrame.ZIndex = 60
sellFrame.ClipsDescendants = true
Instance.new("UICorner", sellFrame).CornerRadius = UDim.new(0,14)

-- HEADER
local header = Instance.new("TextLabel", sellFrame)
header.Size = UDim2.new(1,0,0,36)
header.Text = "SELL FISH"
header.TextColor3 = Theme.Text
header.Font = Enum.Font.GothamBold
header.TextSize = 13
header.BackgroundTransparency = 1

-- DIVIDER
local div = Instance.new("Frame", sellFrame)
div.Size = UDim2.new(1,-24,0,1)
div.Position = UDim2.fromOffset(12,36)
div.BackgroundColor3 = Color3.fromRGB(60,60,70)
div.BackgroundTransparency = 0.6

-- LIST HOLDER
local list = Instance.new("Frame", sellFrame)
list.Position = UDim2.fromOffset(0,44)
list.Size = UDim2.new(1,0,1,-44)
list.BackgroundTransparency = 1

local layout = Instance.new("UIListLayout", list)
layout.Padding = UDim.new(0,6)
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center

-- POSISI MENGIKUTI TOMBOL
local function updateSellPos()
    local p = sellDrop.AbsolutePosition
    local s = sellDrop.AbsoluteSize
    local m = main.AbsolutePosition

    sellFrame.Position = UDim2.fromOffset(
        p.X - m.X,
        p.Y - m.Y + s.Y + 8
    )
end

-- TOGGLE
sellDrop.MouseButton1Click:Connect(function()
    updateSellPos()
    sellFrame.Visible = not sellFrame.Visible

    TweenService:Create(
        sellFrame,
        TweenInfo.new(0.35, Enum.EasingStyle.Quart, Enum.EasingDirection.Out),
        {
            Size = sellFrame.Visible
                and UDim2.fromOffset(300, 44 + #rarities * 34 + 10)
                or UDim2.fromOffset(300, 0)
        }
    ):Play()
end)

-- ITEM SELL
for _, rarity in ipairs(rarities) do
    local btn = Instance.new("TextButton", list)
    btn.Size = UDim2.fromOffset(260,30)
    btn.Text = "Sell "..rarity
    btn.BackgroundColor3 = Theme.Secondary
    btn.TextColor3 = Theme.TextDark
    btn.Font = Enum.Font.GothamSemibold
    btn.TextSize = 12
    btn.AutoButtonColor = false
    btn.ZIndex = 61
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,8)

    btn.MouseEnter:Connect(function()
        btn.BackgroundColor3 = Color3.fromRGB(30,32,42)
        btn.TextColor3 = Theme.Text
    end)

    btn.MouseLeave:Connect(function()
        btn.BackgroundColor3 = Theme.Secondary
        btn.TextColor3 = Theme.TextDark
    end)

    btn.MouseButton1Click:Connect(function()
        ReplicatedStorage:WaitForChild("RequestSell"):FireServer(rarity)
    end)
end

-- 5. START BUTTON
local toggle, toggleStroke = createButton("START FISHING", Theme.Green, 10)
toggle.Size = UDim2.new(1, -4, 0, 55)
toggle.TextSize = 16

toggle.MouseButton1Click:Connect(function()
    AUTO = not AUTO
    if AUTO then
        toggle.Text = "STOP SYSTEM"
        toggleStroke.Color = Theme.Red
        toggle.TextColor3 = Theme.Red
    else
        toggle.Text = "START FISHING"
        toggleStroke.Color = Theme.Green
        toggle.TextColor3 = Theme.Text
    end
end)

--// 3. BACKPACK LIST (REALTIME QUANTITY)
local bpFrame = Instance.new("Frame", main)
bpFrame.Size = UDim2.new(1, -30, 0, 90)
bpFrame.Position = UDim2.new(0, 15, 1, -105)
bpFrame.BackgroundColor3 = Theme.Secondary
Instance.new("UICorner", bpFrame).CornerRadius = UDim.new(0, 10)

local bpScroll = Instance.new("ScrollingFrame", bpFrame)
bpScroll.Size = UDim2.new(1, -10, 1, -10)
bpScroll.Position = UDim2.fromOffset(5, 5)
bpScroll.BackgroundTransparency = 1
bpScroll.ScrollBarThickness = 2
bpScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
bpScroll.CanvasSize = UDim2.new(0,0,0,0)
Instance.new("UIListLayout", bpScroll).Padding = UDim.new(0, 3)

local function updateBPList()
    for _, v in ipairs(bpScroll:GetChildren()) do
        if v:IsA("TextLabel") then
            v:Destroy()
        end
    end

    local counts = {}

    local function scan(container)
        for _, item in ipairs(container:GetChildren()) do
            if item:IsA("Tool")
            or item:IsA("Model")
            or item:IsA("StringValue")
            or item:IsA("IntValue") then
                counts[item.Name] = (counts[item.Name] or 0) + 1
            end
        end
    end

    -- Scan Backpack
    scan(Player.Backpack)

    -- Scan Character
    if Player.Character then
        scan(Player.Character)
    end

    -- ðŸ”¥ OPTIONAL: Scan folder inventory khusus (kalau ada)
    local inv = Player:FindFirstChild("Inventory")
    if inv then
        scan(inv)
    end

    for name, qty in pairs(counts) do
        local l = Instance.new("TextLabel", bpScroll)
        l.Size = UDim2.new(1, 0, 0, 18)
        l.BackgroundTransparency = 1
        l.Text = "ðŸŽ’ "..name.." x"..qty
        l.TextColor3 = Theme.Accent
        l.Font = Enum.Font.GothamBold
        l.TextSize = 12
        l.TextXAlignment = Enum.TextXAlignment.Left
    end
end

Player.Backpack.ChildAdded:Connect(updateBPList)
Player.Backpack.ChildRemoved:Connect(updateBPList)

Player.CharacterAdded:Connect(function()
    task.wait(1)
    updateBPList()
end)

task.delay(0.1, updateBPList)

--// ================= WINDOW LOGIC =================
closeBtn.MouseButton1Click:Connect(function() gui:Destroy() end)

local minimized = false
miniBtn.MouseButton1Click:Connect(function()
    minimized = not minimized

    -- hide konten utama
    container.Visible = not minimized

    -- ðŸ”¥ hide backpack list juga
    bpFrame.Visible = not minimized

    local targetSize = minimized
        and UDim2.fromOffset(360, 50)
        or UDim2.fromOffset(360, 480)

    TweenService:Create(
        main,
        TweenInfo.new(0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.Out),
        {Size = targetSize}
    ):Play()

    miniBtn.Text = minimized and "+" or "âˆ’"
end)

--// ================= CORE LOOP =================
task.spawn(function()
    while task.wait(0.3) do
        if not AUTO then continue end
        
        local rod = getNextRod()
        if not rod then continue end
        equipRod(rod)
        task.wait(0.1)
        
        pcall(function()
            rod.Mechanics.Remotes.CastEvent:FireServer(false, 7)
            
            local castPos
            local connection
            connection = ReplicatedStorage.Remotes.BaitLandedEvent.OnClientEvent:Connect(function(pos)
                castPos = pos
                connection:Disconnect()
            end)
            
            local timeout = 0
            while not castPos and timeout < 0.1 do 
                timeout = timeout + task.wait(0.01)
            end
            
            if castPos then
                ReplicatedStorage.Remotes.BaitLandedEvent:FireServer(rod, castPos, "TerrainWater")
            end

            task.wait(INPUT_DELAY)
            rod.Mechanics.Remotes.MiniGame:FireServer(true)
        end)
        
        RodIndex = (RodIndex % #RodList) + 1
    end
end)
ShowWelcome()
